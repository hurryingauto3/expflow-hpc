# Migration Guide: Converting NavSim Implementation to Generic Framework

This guide shows how to convert your existing NavSim experiment manager to use the generic framework, removing all hardcoded paths.

## Overview

**Before**: Hardcoded paths like `/scratch/ah7072`, specific to one user
**After**: Auto-detected paths, works for ANY NYU HPC user

## Step-by-Step Migration

### 1. Initialize New Project Structure

```bash
# On NYU Greene
cd ~
git clone https://github.com/YOUR_USERNAME/expflow-hpc.git
cd expflow-hpc

# Initialize your NavSim project
./hpcexp init navsim-planning

# This creates:
# /scratch/YOUR_NYU_ID/navsim-planning/
#   â”œâ”€â”€ .hpc_config.yaml              (auto-detected!)
#   â”œâ”€â”€ experiment_configs/
#   â”œâ”€â”€ experiment_templates/
#   â”œâ”€â”€ generated_scripts/
#   â””â”€â”€ experiments/
```

### 2. Create NavSim-Specific Manager

Create `navsim_manager.py` in your project:

```python
#!/usr/bin/env python3
"""
NavSim I-JEPA Planning Agent Experiment Manager
Powered by ExpFlow-HPC generic framework
"""

import sys
from pathlib import Path
from dataclasses import dataclass, field
from typing import List, Optional

# Import generic framework
sys.path.insert(0, str(Path.home() / "expflow-hpc"))
from hpcexp_core import BaseExperimentManager, BaseExperimentConfig
from hpc_config import load_project_config


@dataclass
class NavSimConfig(BaseExperimentConfig):
    """NavSim-specific experiment configuration"""

    # Agent configuration
    agent: str = "ijepa_planning_agent_v3"
    backbone: str = "ijepa"
    model_id: Optional[str] = None

    # Training hyperparameters
    batch_size: int = 48
    learning_rate: float = 1e-4
    encoder_learning_rate: float = 3e-5
    trainable_fraction: float = 0.5
    epochs: int = 30
    data_percent: int = 100

    # Multi-camera setup
    use_multi_camera: bool = True
    camera_views: List[str] = field(default_factory=lambda: ["cam_l0", "cam_f0", "cam_r0"])
    vision_mode: str = "multi_per_view"
    image_size: List[int] = field(default_factory=lambda: [224, 224])

    # NavSim paths (relative to project)
    navsim_devkit_root: str = "navsim_refactor"
    data_root: str = "data"
    cache_name: str = "training_cache_v5"

    # Evaluation
    eval_split: str = "navtest"
    eval_workers: int = 48

    # Results
    pdm_score: Optional[float] = None


class NavSimManager(BaseExperimentManager):
    """NavSim experiment manager using generic HPC framework"""

    def _generate_train_script(self, config: dict) -> str:
        """Generate NavSim training script with auto-detected paths"""

        # Get user-specific paths (NO HARDCODING!)
        scratch = self.hpc_config.scratch_dir
        username = self.hpc_config.username

        # Construct paths relative to user's scratch
        navsim_root = f"{scratch}/{config.get('navsim_devkit_root', 'navsim_refactor')}"
        data_root = f"{scratch}/{config.get('data_root', 'data')}"
        cache_name = config.get('cache_name', 'training_cache_v5')
        cache_path = f"{self.cache_dir}/{cache_name}"

        script = f'''#!/bin/bash
# NavSim I-JEPA Training Script
# Generated by ExpFlow-HPC (auto-detected paths)
# User: {username}

#SBATCH --partition={config.get('partition')}
#SBATCH --gres=gpu:{config.get('num_gpus')}
#SBATCH --nodes={config.get('num_nodes')}
#SBATCH --ntasks-per-node={config.get('num_gpus')}
#SBATCH --cpus-per-task={config.get('cpus_per_task')}
#SBATCH --account={config.get('account')}
#SBATCH --time={config.get('time_limit')}
#SBATCH --job-name={config['exp_id']}_train
#SBATCH --output={self.logs_dir}/output/train_{config['exp_id']}_%j.out
#SBATCH --error={self.logs_dir}/error/train_{config['exp_id']}_%j.err

# Environment (auto-detected user paths)
export NAVSIM_DEVKIT_ROOT="{navsim_root}"
export OPENSCENE_DATA_ROOT="{data_root}"
export NUPLAN_MAPS_ROOT="{data_root}/maps"
export NAVSIM_EXP_ROOT="{self.experiments_dir}"

# Cache
export CACHE_PATH="{cache_path}"
mkdir -p "$CACHE_PATH"

# Training configuration
export BATCH_SIZE={config.get('batch_size')}
export LEARNING_RATE={config.get('learning_rate')}
export ENCODER_LR={config.get('encoder_learning_rate')}
export EPOCHS={config.get('epochs')}

# Conda environment
module load anaconda3/2025.06
source activate navsim

# Your existing training command (paths auto-detected!)
cd "$NAVSIM_DEVKIT_ROOT"
python navsim/planning/script/run_training.py \\
    agent={config.get('agent')} \\
    agent.trainable_ijepa_layers_fraction={config.get('trainable_fraction')} \\
    agent.use_multi_camera={str(config.get('use_multi_camera')).lower()} \\
    agent.learning_rate=$LEARNING_RATE \\
    agent.encoder_learning_rate=$ENCODER_LR \\
    experiment_name="{config['exp_id']}" \\
    cache_path="$CACHE_PATH" \\
    trainer.params.max_epochs=$EPOCHS \\
    dataloader.params.batch_size=$BATCH_SIZE

# Save checkpoint path
BEST_CKPT=$(find "$NAVSIM_EXP_ROOT" -name "*{config['exp_id']}*" -name "*.ckpt" | head -1)
echo "$BEST_CKPT" > "{self.checkpoints_dir}/{config['exp_id']}.txt"
'''
        return script

    def _generate_eval_script(self, config: dict) -> str:
        """Generate NavSim evaluation script"""
        # Similar to training, but for evaluation
        # (See full implementation in examples/navsim_planning.py)
        pass

    def harvest_results(self, exp_id: str):
        """Harvest NavSim PDM scores"""
        import pandas as pd

        # Find evaluation CSV
        eval_pattern = f"eval_{config.get('eval_split', 'navtest')}_exp_{exp_id}_*"
        eval_dirs = list((self.experiments_dir / "evaluations").glob(eval_pattern))

        if eval_dirs:
            eval_dir = sorted(eval_dirs)[-1]
            csv_files = list(eval_dir.glob("*.csv"))

            if csv_files:
                df = pd.read_csv(csv_files[0])
                results = {
                    "pdm_score": float(df["pdm_score"].mean()),
                    "no_collision": float(df["no_collision"].mean()),
                    "drivable_area": float(df["drivable_area_compliance"].mean()),
                    # ... other metrics
                }

                # Update metadata
                self.metadata[exp_id]["results"] = results
                self.metadata[exp_id]["status"] = "completed"
                self._save_metadata()

                print(f"âœ“ PDM Score: {results['pdm_score']:.4f}")
                return results

        return {}


# CLI (standard interface)
if __name__ == "__main__":
    import argparse

    # Load auto-detected config
    config = load_project_config()
    manager = NavSimManager(config)

    # Your existing CLI commands work the same!
    # new, submit, harvest, list, export, show
    # (See examples/simple_image_classification.py for full CLI)
```

### 3. Copy Your Templates

```bash
cd /scratch/YOUR_NYU_ID/navsim-planning

# Copy existing templates (update paths)
cat > experiment_templates/ijepa_mlp.yaml << 'EOF'
# I-JEPA MLP Template (generic - no hardcoded paths!)

agent: ijepa_planning_agent_v3
backbone: ijepa
model_id: null

# Training
batch_size: 48
learning_rate: 0.0001
encoder_learning_rate: 0.00003
trainable_fraction: 0.5
epochs: 30
data_percent: 100

# Multi-camera
use_multi_camera: true
camera_views:
  - cam_l0
  - cam_f0
  - cam_r0

# Resources (uses YOUR account automatically)
partition: l40s_public
num_gpus: 4
num_nodes: 1
cpus_per_task: 16
time_limit: "48:00:00"

# NavSim paths (relative to YOUR scratch)
navsim_devkit_root: navsim_refactor
data_root: data
cache_name: training_cache_ijepa_v5

# Evaluation
eval_split: navtest
eval_workers: 48
EOF
```

### 4. Test Migration

```bash
# Create test experiment
python navsim_manager.py new \
    --exp-id test_migration \
    --template ijepa_mlp \
    --description "Test generic framework"

# Check generated script (paths should be auto-detected!)
cat generated_scripts/train_test_migration.slurm | grep scratch

# Should show YOUR scratch path, not /scratch/ah7072!
```

### 5. Key Differences

**Old (Hardcoded)**:
```python
workspace_root = "/scratch/ah7072"  # HARDCODED!
account = "torch_pr_68_tandon_advanced"  # HARDCODED!
```

**New (Auto-Detected)**:
```python
config = load_project_config()  # Auto-detects everything!
scratch = config.scratch_dir    # /scratch/YOUR_NYU_ID
account = config.default_account  # Your SLURM account
```

## Benefits After Migration

### 1. Shareable with Team
```bash
# Your colleague can use the same code!
git clone your-repo
cd your-repo
./hpcexp init navsim-planning  # Auto-detects THEIR NYU ID!
```

### 2. No More Path Errors
```bash
# Before: Fails if /scratch/ah7072 doesn't exist
# After: Works for ANYONE on Greene
```

### 3. Portable Across Clusters
```bash
# Works on Greene, Perlmutter, Summit, etc.
# Just change cluster_name in config
```

### 4. Cleaner Git History
```bash
# No more commits like:
# "Update hardcoded path"
# "Fix username in script"
# "Update account name"
```

## Common Migration Pitfalls

### âŒ Mistake 1: Hardcoding in Templates
```yaml
# BAD (old way)
account: torch_pr_68_tandon_advanced  # Only works for one user!

# GOOD (new way)
# Omit account - uses auto-detected default
# Or override per-experiment if needed
```

### âŒ Mistake 2: Absolute Paths in Configs
```yaml
# BAD
data_path: /scratch/ah7072/data

# GOOD
data_path: data  # Relative to scratch_dir
```

### âŒ Mistake 3: Not Using Config Object
```python
# BAD
scratch = "/scratch/ah7072"

# GOOD
scratch = self.hpc_config.scratch_dir
```

## Testing Checklist

- [ ] `hpcexp info` shows YOUR username
- [ ] `hpcexp init` creates paths in YOUR scratch
- [ ] Generated scripts use YOUR paths (not ah7072)
- [ ] Templates work without modification
- [ ] Submission succeeds with YOUR SLURM account
- [ ] Another user can clone and run without changes

## Rollout Strategy

### Option 1: Gradual Migration
1. Keep old experiment_manager.py working
2. Create new navsim_manager.py using framework
3. Run experiments in parallel
4. Once confident, switch to new system

### Option 2: Clean Break
1. Backup old system
2. Initialize new framework
3. Migrate templates
4. Update documentation
5. Inform team

## Questions?

See:
- `SETUP_GUIDE.md` - Detailed setup instructions
- `examples/navsim_planning.py` - Full NavSim implementation
- `README.md` - Framework overview

---

**Result**: Your NavSim experiment manager now works for ANY NYU HPC user! ðŸŽ‰
